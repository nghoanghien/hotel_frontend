# Module 07: Hotel Management (Partner Portal)

## Authorization & Permissions

> **Hệ thống phân quyền động**: Sử dụng `[Authorize(Policy = "Permission:xxx")]` thay vì role-based cứng

### Permission Policies

| Policy | Mô tả | Cho phép |
|--------|-------|----------|
| `Permission:hotels.read` | Xem danh sách hotels | Tất cả authenticated users |
| `Permission:hotels.create` | Tạo hotel mới | BrandAdmin (của brand đó) |
| `Permission:hotels.update` | Cập nhật thông tin hotel | BrandAdmin (brand), HotelManager (hotel được assign) |
| `Permission:hotels.delete` | Xóa hotel | BrandAdmin (của brand đó) |

### Role-Based Access Matrix

| Action | SuperAdmin | BrandAdmin | HotelManager | Receptionist | Staff |
|--------|------------|------------|--------------|--------------|-------|
| Xem hotels | Read (all) | Read (own) | Read (own) | Read (own) | Read (own) |
| Tạo hotel | ❌ | ✅ | ❌ | ❌ | ❌ |
| Sửa hotel | ❌ | ✅ (own) | ✅ (own) | ❌ | ❌ |
| Xóa hotel | ❌ | ✅ (own) | ❌ | ❌ | ❌ |

### Context-Based Checks

Backend sử dụng `PermissionContext` để kiểm tra:
- **SuperAdmin**: Chỉ có quyền read (không CRUD hotels trực tiếp)
- **BrandAdmin**: Chỉ truy cập hotels trong brand của mình
- **HotelManager**: Chỉ truy cập hotel được assign
- **Receptionist/Staff**: Quyền hạn chế, có thể bị override bởi user-specific permissions

---

## Screens

| Screen | Route | M� t? |
|--------|-------|-------|
| Hotels List | `/manage/hotels` | Danh s�ch hotels c?a partner |
| Hotel Detail | `/manage/hotels/[id]` | Chi ti?t & ch?nh s?a hotel |
| Add Hotel | `/manage/hotels/new` | Th�m hotel m?i |
| Hotel Settings | `/manage/hotels/[id]/settings` | C�i ??t hotel |
| Hotel Images | `/manage/hotels/[id]/images` | Qu?n l� ?nh |
| Hotel Amenities | `/manage/hotels/[id]/amenities` | Qu?n l� ti?n �ch |

---

## API Endpoints

### 1. Get My Hotels
```http
GET /api/hotels/my-hotels
Authorization: Bearer {token}
```
**Required Policy:** `Permission:hotels.read`

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "Sunset Beach Resort",
      "imageUrl": "https://...",
      "city": "Da Nang",
      "country": "Vietnam",
      "starRating": 5,
      "averageRating": 4.5,
      "reviewCount": 234,
      "totalRooms": 120,
      "isActive": true,
      "isVerified": true,
      "todayStats": {
        "checkIns": 15,
        "checkOuts": 12,
        "occupancyRate": 85
      }
    }
  ]
}
```

---

### 2. Get Hotel Detail (for editing)
```http
GET /api/hotels/{id}
Authorization: Bearer {token}
```

**Response:** Full hotel detail (see Module 02)

---

### 3. Create Hotel
```http
POST /api/hotels
Authorization: Bearer {token}
```
**Required Policy:** `Permission:hotels.create` + BrandAdmin role

**Request:**
```json
{
  "brandId": "uuid",
  "name": "Sunset Beach Resort",
  "description": "Luxury beachfront resort in Da Nang",
  "address": "123 Beach Road",
  "city": "Da Nang",
  "state": "",
  "country": "Vietnam",
  "postalCode": "550000",
  "latitude": 16.0544,
  "longitude": 108.2022,
  "phoneNumber": "+84-236-1234-567",
  "email": "info@sunsetbeach.com",
  "website": "https://sunsetbeach.com",
  "starRating": 5,
  "totalRooms": 120,
  "numberOfFloors": 10,
  "checkInTime": "14:00",
  "checkOutTime": "12:00",
  "cancellationPolicy": "Free cancellation up to 48 hours before check-in",
  "childPolicy": "Children under 12 stay free",
  "petPolicy": "Pets allowed with 1,250,000 VND fee",
  "smokingPolicy": "No smoking"
}
```

---

### 4. Update Hotel
```http
PUT /api/hotels/{id}
Authorization: Bearer {token}
```
**Required Policy:** `Permission:hotels.update` + scope check (BrandAdmin own brand / HotelManager own hotel)

**Request:** Same as create (partial update supported)

---

### 5. Upload Hotel Image
```http
POST /api/hotels/{id}/images
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [image file]
caption: "Hotel lobby"
category: "lobby" | "room" | "restaurant" | "pool" | "exterior" | "other"
isPrimary: false
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "imageUrl": "https://...",
    "caption": "Hotel lobby",
    "category": "lobby",
    "isPrimary": false,
    "displayOrder": 5
  }
}
```

---

### 6. Update Image Order
```http
PUT /api/hotels/{id}/images/reorder
Authorization: Bearer {token}
```

**Request:**
```json
{
  "imageIds": ["uuid1", "uuid2", "uuid3"]
}
```

---

### 7. Delete Hotel Image
```http
DELETE /api/hotels/{id}/images/{imageId}
Authorization: Bearer {token}
```

---

### 8. Get Hotel Amenities
```http
GET /api/hotels/{id}/amenities
Authorization: Bearer {token}
```

---

### 9. Update Hotel Amenities
```http
PUT /api/hotels/{id}/amenities
Authorization: Bearer {token}
```

**Request:**
```json
{
  "amenities": [
    {
      "amenityId": "uuid",
      "isComplimentary": true,
      "additionalCost": null,
      "operatingHours": "24/7",
      "notes": "Available for all guests"
    }
  ]
}
```

---

### 10. Get All Available Amenities
```http
GET /api/amenities
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "Free WiFi",
      "icon": "wifi",
      "type": "General",
      "description": "High-speed internet access"
    },
    {
      "id": "uuid",
      "name": "Swimming Pool",
      "icon": "pool",
      "type": "Facilities",
      "description": "Outdoor swimming pool"
    }
  ]
}
```

---

### 11. Toggle Hotel Active Status
```http
POST /api/hotels/{id}/toggle-status
Authorization: Bearer {token}
```
**Required Policy:** `Permission:hotels.update` + BrandAdmin (own brand)

---

## Hotel Settings API

### 12. Get Hotel Settings
```http
GET /api/hotels/{id}/settings
Authorization: Bearer {token}
```
**Response:** Full hotel settings (for BrandAdmin/HotelManager)
```json
{
  "success": true,
  "data": {
    "timeConfig": {
      "checkInTime": "14:00",
      "checkOutTime": "12:00"
    },
    "guestConfig": {
      "maxAdultsPerRoom": 2,
      "maxChildrenPerRoom": 1,
      "maxGuestsPerRoom": 4,
      "allowExtraBed": true,
      "extraBedPrice": 500000
    },
    "bookingRules": {
      "minNights": 1,
      "maxNights": 30,
      "minAdvanceBookingHours": 24,
      "maxAdvanceBookingDays": 365
    },
    "paymentConfig": {
      "enableStripePayment": true,
      "enablePayAtHotel": true,
      "stripeAccountId": "acct_xxx"
    },
    "taxFeeConfig": {
      "taxRate": 0.10,
      "serviceFeeRate": 0.05
    },
    "policies": {
      "cancellationPolicy": "Free cancellation 48h before check-in",
      "childPolicy": "Children under 12 stay free",
      "petPolicy": "Pets allowed with fee",
      "smokingPolicy": "No smoking in rooms"
    }
  }
}
```

### 13. Update Hotel Settings
```http
PUT /api/hotels/{id}/settings
Authorization: Bearer {token}
```
**Required Policy:** `Permission:hotels.update`

**Request:**
```json
{
  "timeConfig": {
    "checkInTime": "15:00",
    "checkOutTime": "11:00"
  },
  "guestConfig": {
    "maxAdultsPerRoom": 3,
    "maxChildrenPerRoom": 2,
    "maxGuestsPerRoom": 5,
    "allowExtraBed": true,
    "extraBedPrice": 750000
  },
  "bookingRules": {
    "minNights": 2,
    "maxNights": 14,
    "minAdvanceBookingHours": 48,
    "maxAdvanceBookingDays": 180
  },
  "paymentConfig": {
    "enableStripePayment": true,
    "enablePayAtHotel": false,
    "stripeAccountId": "acct_xxx"
  },
  "policies": {
    "cancellationPolicy": "Free cancellation 72h before check-in",
    "childPolicy": "Children under 6 stay free",
    "petPolicy": "No pets allowed",
    "smokingPolicy": "Smoking area available"
  }
}
```

### 14. Get Public Hotel Settings (for Guest)
```http
GET /api/hotels/{id}/public-settings
```
**Response:** Public-facing settings (no sensitive data)
```json
{
  "success": true,
  "data": {
    "checkInTime": "14:00",
    "checkOutTime": "12:00",
    "maxGuestsPerRoom": 4,
    "allowExtraBed": true,
    "extraBedPrice": 500000,
    "cancellationPolicy": "Free cancellation 48h before check-in",
    "childPolicy": "Children under 12 stay free",
    "petPolicy": "Pets allowed with fee",
    "smokingPolicy": "No smoking in rooms",
    "paymentMethods": {
      "stripePayment": true,
      "payAtHotel": true
    }
  }
}
```

---

## Screen Specifications

### Hotels List Screen
```
????????????????????????????????????????????????????
?  ?? My Hotels                       [+ Add New]  ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? ??? ? Sunset Beach Resort           ?5   ? ?
?  ?    ? Da Nang, Vietnam     ?  Active      ? ?
?  ?    ? ? 4.5 (234 reviews)                 ? ?
?  ?    ? ?????????????????????????????????   ? ?
?  ?    ? Today: 15 check-ins � 12 check-outs ? ?
?  ?    ? Occupancy: 85%                      ? ?
?  ?    ?                        [Manage ?]   ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? ??? ? Sunset City Hotel             ?4   ? ?
?  ?    ? Ho Chi Minh City     ?  Inactive    ? ?
?  ?    ? ? 4.2 (180 reviews)                 ? ?
?  ?    ? ?????????????????????????????????   ? ?
?  ?    ? Today: 0 check-ins � 0 check-outs   ? ?
?  ?    ? Occupancy: 0%                       ? ?
?  ?    ?                        [Manage ?]   ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????
```

### Hotel Edit Screen
```
????????????????????????????????????????????????????
?  ? Back        Sunset Beach Resort        Save   ?
????????????????????????????????????????????????????
?  [Overview] [Rooms] [Images] [Amenities] [Policies]?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Basic Information ????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Hotel Name *                               ? ?
?  ? Sunset Beach Resort                        ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Description                                ? ?
?  ? Luxury beachfront resort in Da Nang...     ? ?
?  ?????????????????????????????????????????????? ?
?  ???????????????????? ????????????????????????  ?
?  ? Star Rating *    ? ? Total Rooms          ?  ?
?  ? ?????         ? ? 120                  ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? Contact Information ??????????????????????  ?
?  [Phone, Email, Website fields...]              ?
?                                                  ?
?  ??? Location ?????????????????????????????????  ?
?  [Address fields + Map picker...]               ?
?                                                  ?
?  ??? Status ???????????????????????????????????  ?
?  [?] Active - Accepting bookings                ?
?  [ ] Inactive - Hidden from search              ?
?                                                  ?
????????????????????????????????????????????????????
```

### Images Management Screen
```
????????????????????????????????????????????????????
?  ? Back          Hotel Images          [+ Upload]?
????????????????????????????????????????????????????
?  Drag to reorder � Click ? to set as primary   ?
????????????????????????????????????????????????????
?  ?????????? ?????????? ?????????? ??????????   ?
?  ?  ?    ? ?        ? ?        ? ?        ?   ?
?  ?  ???   ? ?  ???   ? ?  ???   ? ?  ???   ?   ?
?  ?        ? ?        ? ?        ? ?        ?   ?
?  ? Lobby  ? ? Pool   ? ? Room   ? ? Beach  ?   ?
?  ?  ?  ??? ? ?  ?  ??? ? ?  ?  ??? ? ?  ?  ??? ?   ?
?  ?????????? ?????????? ?????????? ??????????   ?
?  ?????????? ?????????? ??????????              ?
?  ?        ? ?        ? ?   +    ?              ?
?  ?  ???   ? ?  ???   ? ?  Add   ?              ?
?  ?        ? ?        ? ? Photo  ?              ?
?  ? Rest.  ? ? Spa    ? ?        ?              ?
?  ?  ?  ??? ? ?  ?  ??? ? ?        ?              ?
?  ?????????? ?????????? ??????????              ?
????????????????????????????????????????????????????
```

### Amenities Management Screen
```
????????????????????????????????????????????????????
?  ? Back          Hotel Amenities          Save   ?
????????????????????????????????????????????????????
?  ??? General ??????????????????????????????????  ?
?  ? ?? Free WiFi              ? Free             ?
?  ? ??? Parking                ? Free  250k VND/day?
?  ? ?? Luggage Storage        ? Free             ?
?                                                  ?
?  ??? Facilities ???????????????????????????????  ?
?  ? ?? Swimming Pool          Operating: 6AM-8PM ?
?  ? ??? Fitness Center         Operating: 24/7    ?
?  ? ?? Spa                    ? Free  1.250k+    ?
?  ? ?? Tennis Court                              ?
?                                                  ?
?  ??? Services ?????????????????????????????????  ?
?  ? ?? Breakfast              ? Free  500k/person?
?  ? ?? Airport Transfer       ? Free  750k VND   ?
?  ? ?? Room Service           Operating: 6AM-10PM?
?  ? ?? Laundry Service        ? Free  Extra fee  ?
?                                                  ?
?  ??? Business ?????????????????????????????????  ?
?  ? ?? Business Center                           ?
?  ? ?? Conference Room        Capacity: 100 pax  ?
?                                                  ?
????????????????????????????????????????????????????
```

---

## TypeScript Types

```typescript
interface HotelManagementDto {
  id: string;
  name: string;
  imageUrl?: string;
  city: string;
  country: string;
  starRating: number;
  averageRating: number;
  reviewCount: number;
  totalRooms: number;
  isActive: boolean;
  isVerified: boolean;
  todayStats: HotelDayStats;
}

interface HotelDayStats {
  checkIns: number;
  checkOuts: number;
  occupancyRate: number;
}

interface CreateHotelRequest {
  brandId: string;
  name: string;
  description?: string;
  address: string;
  city: string;
  state?: string;
  country: string;
  postalCode?: string;
  latitude?: number;
  longitude?: number;
  phoneNumber?: string;
  email?: string;
  website?: string;
  starRating: number;
  totalRooms?: number;
  numberOfFloors?: number;

  // Time Config
  checkInTime?: string;
  checkOutTime?: string;

  // Guest Config
  maxAdultsPerRoom?: number;
  maxChildrenPerRoom?: number;
  maxGuestsPerRoom?: number;
  allowExtraBed?: boolean;
  extraBedPrice?: number;

  // Booking Rules
  minNights?: number;
  maxNights?: number;
  minAdvanceBookingHours?: number;
  maxAdvanceBookingDays?: number;

  // Payment Config
  enableStripePayment?: boolean;
  enablePayAtHotel?: boolean;
  stripeAccountId?: string;

  // Tax & Fee
  taxRate?: number;
  serviceFeeRate?: number;

  // Policies
  cancellationPolicy?: string;
  childPolicy?: string;
  petPolicy?: string;
  smokingPolicy?: string;
}

interface HotelImageDto {
  id: string;
  imageUrl: string;
  caption?: string;
  category?: string;
  isPrimary: boolean;
  displayOrder: number;
}

interface HotelAmenityDto {
  id: string;
  amenityId: string;
  amenity: AmenityDto;
  isComplimentary: boolean;
  additionalCost?: number;
  operatingHours?: string;
  notes?: string;
}

interface AmenityDto {
  id: string;
  name: string;
  icon?: string;
  type: AmenityType;
  description?: string;
}

// ============ HOTEL SETTINGS TYPES ============

interface HotelSettingsDto {
  timeConfig: TimeConfigDto;
  guestConfig: GuestConfigDto;
  bookingRules: BookingRulesDto;
  paymentConfig: PaymentConfigDto;
  taxFeeConfig: TaxFeeConfigDto;
  policies: PoliciesDto;
}

interface TimeConfigDto {
  checkInTime: string;  // "14:00"
  checkOutTime: string; // "12:00"
}

interface GuestConfigDto {
  maxAdultsPerRoom: number;
  maxChildrenPerRoom: number;
  maxGuestsPerRoom: number;
  allowExtraBed: boolean;
  extraBedPrice?: number;
}

interface BookingRulesDto {
  minNights: number;
  maxNights: number;
  minAdvanceBookingHours: number;
  maxAdvanceBookingDays: number;
}

interface PaymentConfigDto {
  enableStripePayment: boolean;  // Pay online via Stripe
  enablePayAtHotel: boolean;     // Pay at front desk
  stripeAccountId?: string;
}

interface TaxFeeConfigDto {
  taxRate: number;        // 0.10 = 10%
  serviceFeeRate: number; // 0.05 = 5%
}

interface PoliciesDto {
  cancellationPolicy?: string;
  childPolicy?: string;
  petPolicy?: string;
  smokingPolicy?: string;
}

interface HotelPublicSettingsDto {
  checkInTime: string;
  checkOutTime: string;
  maxGuestsPerRoom: number;
  allowExtraBed: boolean;
  extraBedPrice?: number;
  cancellationPolicy?: string;
  childPolicy?: string;
  petPolicy?: string;
  smokingPolicy?: string;
  paymentMethods: {
    stripePayment: boolean;
    payAtHotel: boolean;
  };
}

enum AmenityType {
  General = 0,
  Room = 1,
  Bathroom = 2,
  Kitchen = 3,
  Entertainment = 4,
  Service = 5,
  Facilities = 6
}

// ============ PERMISSION TYPES ============

interface UserPermissions {
  permissions: string[];
  scope: 'system' | 'brand' | 'hotel';
  brandId?: string;
  hotelId?: string;
}

interface PermissionCheckResult {
  hasPermission: boolean;
  permission: string;
  scope: string;
}

const PERMISSION_POLICIES = {
  HOTELS_READ: 'Permission:hotels.read',
  HOTELS_CREATE: 'Permission:hotels.create',
  HOTELS_UPDATE: 'Permission:hotels.update',
  HOTELS_DELETE: 'Permission:hotels.delete',
  ROOMS_READ: 'Permission:rooms.read',
  ROOMS_CREATE: 'Permission:rooms.create',
  BOOKINGS_READ: 'Permission:bookings.read',
  BOOKINGS_CHECKIN: 'Permission:bookings.checkin',
  BOOKINGS_CHECKOUT: 'Permission:bookings.checkout',
  DASHBOARD_VIEW: 'Permission:dashboard.view',
  USERS_READ: 'Permission:users.read',
  USERS_CREATE: 'Permission:users.create',
} as const;
