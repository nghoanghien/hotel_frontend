# Module 03: Booking & Checkout

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Booking Form | `/booking/new` | Form ?i?n thông tin ??t phòng |
| Review Booking | `/booking/review` | Xem l?i tr??c khi thanh toán |
| Checkout | `/checkout` | Trang thanh toán |
| Booking Success | `/booking/[id]/success` | Xác nh?n ??t phòng thành công |
| Booking Detail | `/booking/[id]` | Chi ti?t booking |

---

## Booking Flow

```
???????????????    ???????????????    ???????????????    ???????????????
? Ch?n phòng  ? -> ? Thông tin   ? -> ? Thanh toán  ? -> ? Thành công  ?
?             ?    ?   khách     ?    ?             ?    ?             ?
???????????????    ???????????????    ???????????????    ???????????????
```

---

## API Endpoints

### 1. Create Booking
```http
POST /api/bookings
Authorization: Bearer {token}
```

**Request:**
```json
{
  "hotelId": "uuid",
  "checkInDate": "2024-02-01T14:00:00Z",
  "checkOutDate": "2024-02-03T12:00:00Z",
  "rooms": [
    {
      "roomId": "uuid",
      "numberOfAdults": 2,
      "numberOfChildren": 0,
      "guestName": "Nguy?n V?n A",
      "specialRequests": "Phòng t?ng cao"
    }
  ],
  "guestName": "Nguy?n V?n A",
  "guestEmail": "nguyenvana@example.com",
  "guestPhoneNumber": "+84901234567",
  "specialRequests": "Nh?n phòng tr? kho?ng 22h",
  "currency": "VND",
  "couponCode": "SUMMER20"
}
```

**Response (201):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "confirmationNumber": "BK-20240201-ABC123",
    "status": "Pending",
    "hotelId": "uuid",
    "hotelName": "Marriott Hanoi",
    "hotelAddress": "123 Lý Th??ng Ki?t, Hoàn Ki?m",
    "checkInDate": "2024-02-01T14:00:00Z",
    "checkOutDate": "2024-02-03T12:00:00Z",
    "numberOfGuests": 2,
    "numberOfRooms": 1,
    "rooms": [
      {
        "roomId": "uuid",
        "roomNumber": "301",
        "roomType": "Deluxe King",
        "price": 5000000
      }
    ],
    "subtotal": 5000000,
    "discountAmount": 1000000,
    "taxAmount": 400000,
    "serviceFee": 100000,
    "totalAmount": 4500000,
    "currency": "VND",
    "appliedCouponCode": "SUMMER20",
    "isPaid": false,
    "createdAt": "2024-01-20T10:00:00Z"
  }
}
```

---

### 2. Get Booking Detail
```http
GET /api/bookings/{id}
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "confirmationNumber": "BK-20240201-ABC123",
    "status": "Confirmed",
    "hotel": {
      "id": "uuid",
      "name": "Marriott Hanoi",
      "address": "123 Lý Th??ng Ki?t, Hoàn Ki?m",
      "city": "Hà N?i",
      "imageUrl": "https://...",
      "phoneNumber": "+84-24-1234-5678",
      "checkInTime": "14:00",
      "checkOutTime": "12:00"
    },
    "checkInDate": "2024-02-01T14:00:00Z",
    "checkOutDate": "2024-02-03T12:00:00Z",
    "numberOfGuests": 2,
    "numberOfRooms": 1,
    "rooms": [
      {
        "roomId": "uuid",
        "roomNumber": "301",
        "roomType": "Deluxe King",
        "bedType": "King",
        "numberOfAdults": 2,
        "numberOfChildren": 0,
        "guestName": "Nguy?n V?n A",
        "price": 5000000
      }
    ],
    "guestName": "Nguy?n V?n A",
    "guestEmail": "nguyenvana@example.com",
    "guestPhoneNumber": "+84901234567",
    "specialRequests": "Nh?n phòng tr? kho?ng 22h",
    "subtotal": 5000000,
    "discountAmount": 1000000,
    "taxAmount": 400000,
    "serviceFee": 100000,
    "totalAmount": 4500000,
    "currency": "VND",
    "appliedCouponCode": "SUMMER20",
    "isPaid": true,
    "paidAt": "2024-01-20T10:05:00Z",
    "paymentMethod": "BankTransfer",
    "bookedAt": "2024-01-20T10:00:00Z",
    "confirmedAt": "2024-01-20T10:05:00Z"
  }
}
```

---

### 3. Calculate Booking Price
```http
POST /api/bookings/calculate-price
Authorization: Bearer {token}
```

**Request:**
```json
{
  "hotelId": "uuid",
  "checkInDate": "2024-02-01",
  "checkOutDate": "2024-02-03",
  "rooms": [
    { "roomId": "uuid", "numberOfAdults": 2, "numberOfChildren": 0 }
  ],
  "currency": "VND"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "subtotal": 5000000,
    "taxAmount": 500000,
    "serviceFee": 250000,
    "discountAmount": 0,
    "totalAmount": 5750000,
    "currency": "VND",
    "numberOfNights": 2,
    "roomPrices": [
      {
        "roomId": "uuid",
        "roomNumber": "301",
        "roomType": "Deluxe",
        "pricePerNight": 2500000,
        "totalPrice": 5000000,
        "numberOfNights": 2
      }
    ]
  }
}
```

---

### 4. Create Payment
```http
POST /api/bookings/{bookingId}/payments
Authorization: Bearer {token}
```

**Request:**
```json
{
  "bookingId": "uuid",
  "amount": 4500000,
  "currency": "VND",
  "method": "BankTransfer",
  "gateway": "VNPay",
  "transactionId": "VNP123456789"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Payment created successfully",
  "data": {
    "id": "uuid",
    "bookingId": "uuid",
    "transactionId": "VNP123456789",
    "amount": 4500000,
    "currency": "VND",
    "method": "BankTransfer",
    "status": "Pending",
    "gateway": "VNPay",
    "createdAt": "2024-01-20T10:05:00Z"
  }
}
```

---

### 5. Validate Promotion Code
```http
POST /api/promotions/validate
Authorization: Bearer {token}
```

**Request:**
```json
{
  "code": "SUMMER20",
  "hotelId": "uuid",
  "bookingAmount": 5000000,
  "checkInDate": "2024-02-01",
  "checkOutDate": "2024-02-03"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "isValid": true,
    "code": "SUMMER20",
    "promotionName": "Summer Sale 20%",
    "discountType": "Percentage",
    "discountValue": 20,
    "calculatedDiscount": 1000000,
    "message": "Gi?m 20% ?ã ???c áp d?ng!"
  }
}
```

**Response - Invalid:**
```json
{
  "success": true,
  "data": {
    "isValid": false,
    "message": "Mã khuy?n mãi ?ã h?t h?n"
  }
}
```

---

### 6. Get My Bookings
```http
GET /api/bookings/my-bookings
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Mô t? |
|-------|------|-------|
| `status` | string | `Upcoming`, `Completed`, `Cancelled` |
| `page` | int | |
| `pageSize` | int | |

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "confirmationNumber": "BK-20240201-ABC123",
        "status": "Confirmed",
        "hotelName": "Marriott Hanoi",
        "hotelImageUrl": "https://...",
        "checkInDate": "2024-02-01T14:00:00Z",
        "checkOutDate": "2024-02-03T12:00:00Z",
        "numberOfRooms": 1,
        "totalAmount": 4500000,
        "currency": "VND"
      }
    ],
    "totalCount": 5
  }
}
```

---

### 7. Cancel Booking
```http
POST /api/bookings/{id}/cancel
Authorization: Bearer {token}
```

**Request:**
```json
{
  "reason": "Thay ??i k? ho?ch"
}
```

**Response:**
```json
{
  "success": true,
  "message": "H?y ??t phòng thành công",
  "data": true
}
```

---

## Screen Specifications

### Booking Form Screen
```
????????????????????????????????????????????????????
?  ? Quay l?i           Thông tin ??t phòng        ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? ??? ? Marriott Hanoi               ?5   ? ?
?  ?    ? Deluxe King Room                     ? ?
?  ?    ? 01/02 - 03/02/2024 (2 ?êm)           ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Thông tin khách ??????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? H? và tên *                                ? ?
?  ? Nguy?n V?n A                               ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Email *                                    ? ?
?  ? nguyenvana@example.com                     ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? S? ?i?n tho?i *                            ? ?
?  ? +84 901 234 567                            ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Yêu c?u ??c bi?t (tùy ch?n)                ? ?
?  ? Nh?n phòng tr? kho?ng 22h                  ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Mã khuy?n mãi ????????????????????????????  ?
?  ???????????????????????????? ????????????????  ?
?  ? SUMMER20                 ? ?   Áp d?ng    ?  ?
?  ???????????????????????????? ????????????????  ?
?  ? Gi?m 20% (-1,000,000 VND)                   ?
?                                                  ?
?  ??? Chi ti?t giá ?????????????????????????????  ?
?  2 ?êm x 2,500,000 VND            5,000,000 VND ?
?  Gi?m giá (SUMMER20)             -1,000,000 VND ?
?  Thu? & phí                         400,000 VND ?
?  Phí d?ch v?                        100,000 VND ?
?  ????????????????????????????????????????????   ?
?  T?ng c?ng                       4,500,000 VND  ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ?          Ti?p t?c thanh toán               ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  B?ng vi?c ti?p t?c, b?n ??ng ý v?i ?i?u kho?n  ?
????????????????????????????????????????????????????
```

### Booking Success Screen
```
????????????????????????????????????????????????????
?                                                  ?
?                   ?                             ?
?           ??t phòng thành công!                  ?
?                                                  ?
?     Mã xác nh?n: BK-20240201-ABC123             ?
?                                                  ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ?           Marriott Hanoi                   ? ?
?  ?                                            ? ?
?  ?  Nh?n phòng        Tr? phòng               ? ?
?  ?  T5, 01/02         T7, 03/02               ? ?
?  ?  14:00             12:00                   ? ?
?  ?                                            ? ?
?  ?  Deluxe King Room • 2 Khách                ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  Email xác nh?n ?ã ???c g?i ??n                 ?
?  nguyenvana@example.com                         ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ?           Xem chi ti?t ??t phòng           ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ?           V? trang ch?                     ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????
```

---

## Payment Methods

Backend h? tr? các ph??ng th?c thanh toán:

| Method | Enum Value | Mô t? |
|--------|------------|-------|
| Th? tín d?ng | `CreditCard` | Visa, Mastercard, JCB |
| Th? ghi n? | `DebitCard` | ATM n?i ??a |
| Chuy?n kho?n | `BankTransfer` | VNPay, Momo, ZaloPay |
| Ví ?i?n t? | `EWallet` | Momo, ZaloPay, VNPay |
| Ti?n m?t | `Cash` | Thanh toán t?i qu?y |

---

## Error Handling

| Error Code | Message | Action |
|------------|---------|--------|
| 400 | Phòng không còn tr?ng | Redirect ch?n phòng khác |
| 400 | Mã khuy?n mãi không h?p l? | Hi?n th? l?i, cho th? l?i |
| 402 | Thanh toán th?t b?i | Hi?n th? l?i, cho th? l?i |
| 409 | Phòng ?ã ???c ??t | Refresh l?i danh sách phòng |

---

## TypeScript Types

```typescript
interface CreateBookingRequest {
  hotelId: string;
  checkInDate: string;
  checkOutDate: string;
  rooms: BookingRoomRequest[];
  guestName: string;
  guestEmail: string;
  guestPhoneNumber: string;
  specialRequests?: string;
  currency: string;
  couponCode?: string;
}

interface BookingRoomRequest {
  roomId: string;
  numberOfAdults: number;
  numberOfChildren: number;
  guestName?: string;
  specialRequests?: string;
}

interface BookingDto {
  id: string;
  confirmationNumber: string;
  status: BookingStatus;
  hotelId: string;
  hotelName: string;
  hotelAddress: string;
  checkInDate: string;
  checkOutDate: string;
  numberOfGuests: number;
  numberOfRooms: number;
  rooms: BookedRoomDto[];
  subtotal: number;
  discountAmount: number;
  taxAmount: number;
  serviceFee: number;
  totalAmount: number;
  currency: string;
  appliedCouponCode?: string;
  isPaid: boolean;
  createdAt: string;
}

interface BookedRoomDto {
  roomId: string;
  roomNumber: string;
  roomType: string;
  price: number;
}

enum BookingStatus {
  Pending = 0,
  Confirmed = 1,
  CheckedIn = 2,
  CheckedOut = 3,
  Cancelled = 4,
  NoShow = 5
}

interface PaymentRequest {
  bookingId: string;
  amount: number;
  currency: string;
  method: PaymentMethod;
  gateway: string;
  transactionId: string;
}

enum PaymentMethod {
  CreditCard = 0,
  DebitCard = 1,
  BankTransfer = 2,
  EWallet = 3,
  Cash = 4,
  OnlinePayment = 5
}
