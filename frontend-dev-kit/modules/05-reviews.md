# Module 05: Reviews & Ratings

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Hotel Reviews | `/hotels/[id]/reviews` | Danh sách reviews c?a hotel |
| Write Review | `/bookings/[id]/review` | Vi?t review sau khi checkout |
| My Reviews | `/profile/reviews` | Reviews ?ã vi?t |

---

## API Endpoints

### 1. Get Hotel Reviews
```http
GET /api/hotels/{hotelId}/reviews
```

**Query Parameters:**
| Param | Type | Default | Mô t? |
|-------|------|---------|-------|
| `rating` | int | - | Filter by rating (1-5) |
| `sortBy` | string | date | `date`, `rating`, `helpful` |
| `sortDesc` | bool | true | |
| `page` | int | 1 | |
| `pageSize` | int | 10 | |

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "rating": 5,
        "title": "Amazing stay!",
        "comment": "The room was spotless and the staff was incredibly friendly...",
        "cleanlinessRating": 5,
        "serviceRating": 5,
        "locationRating": 5,
        "valueRating": 4,
        "stayDate": "2024-01-10",
        "isVerified": true,
        "helpfulCount": 12,
        "notHelpfulCount": 1,
        "guest": {
          "firstName": "John",
          "lastName": "D.",
          "avatarUrl": "https://...",
          "nationality": "Vietnam"
        },
        "managementResponse": "Thank you for your kind words! We're delighted...",
        "managementResponseAt": "2024-01-16T10:00:00Z",
        "images": [
          { "url": "https://...", "caption": "Room view" }
        ],
        "createdAt": "2024-01-15T10:00:00Z"
      }
    ],
    "totalCount": 234,
    "page": 1,
    "pageSize": 10,
    "summary": {
      "averageRating": 4.5,
      "totalReviews": 234,
      "ratingBreakdown": {
        "5": 150,
        "4": 50,
        "3": 20,
        "2": 10,
        "1": 4
      },
      "categoryAverages": {
        "cleanliness": 4.7,
        "service": 4.5,
        "location": 4.8,
        "value": 4.2
      }
    }
  }
}
```

---

### 2. Create Review
```http
POST /api/hotels/{hotelId}/reviews
Authorization: Bearer {token}
```

**Request:**
```json
{
  "bookingId": "uuid",
  "rating": 5,
  "title": "Amazing stay!",
  "comment": "The room was spotless and the staff was incredibly friendly. The location is perfect, just 5 minutes walk from the main attractions.",
  "cleanlinessRating": 5,
  "serviceRating": 5,
  "locationRating": 5,
  "valueRating": 4,
  "stayDate": "2024-01-10"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Review submitted successfully",
  "data": {
    "id": "uuid",
    "status": "Pending",
    "message": "Your review will be published after moderation"
  }
}
```

---

### 3. Upload Review Images
```http
POST /api/hotels/{hotelId}/reviews/{reviewId}/images
Authorization: Bearer {token}
Content-Type: multipart/form-data

files: [image files, max 5]
caption: "Room view"
```

---

### 4. Mark Review as Helpful
```http
POST /api/hotels/{hotelId}/reviews/{reviewId}/helpful
Authorization: Bearer {token}
```

**Request:**
```json
{
  "isHelpful": true
}
```

---

### 5. Update Review (Owner only)
```http
PUT /api/hotels/{hotelId}/reviews/{reviewId}
Authorization: Bearer {token}
```

**Request:**
```json
{
  "rating": 5,
  "title": "Updated title",
  "comment": "Updated comment...",
  "cleanlinessRating": 5,
  "serviceRating": 5,
  "locationRating": 5,
  "valueRating": 5
}
```

---

### 6. Delete Review (Owner only)
```http
DELETE /api/hotels/{hotelId}/reviews/{reviewId}
Authorization: Bearer {token}
```

---

### 7. Add Management Response (Hotel Manager only)
```http
POST /api/hotels/{hotelId}/reviews/{reviewId}/response
Authorization: Bearer {token}
```

**Request:**
```json
{
  "response": "Thank you for your wonderful review! We're so glad you enjoyed your stay..."
}
```

---

### 8. Get My Reviews
```http
GET /api/guest-profile/reviews
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "hotelId": "uuid",
      "hotelName": "Marriott Saigon",
      "hotelImageUrl": "https://...",
      "rating": 5,
      "title": "Amazing stay!",
      "comment": "The room was spotless...",
      "status": "Published",
      "helpfulCount": 12,
      "stayDate": "2024-01-10",
      "createdAt": "2024-01-15T10:00:00Z"
    }
  ]
}
```

---

### 9. Check if Can Review Booking
```http
GET /api/bookings/{bookingId}/can-review
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "canReview": true,
    "reason": null
  }
}
```

**Or if cannot:**
```json
{
  "success": true,
  "data": {
    "canReview": false,
    "reason": "You have already reviewed this booking"
  }
}
```

---

## Screen Specifications

### Hotel Reviews Screen
```
????????????????????????????????????????????????????
?  ? Back          Reviews (234)                   ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ?         Overall Rating                     ? ?
?  ?                                            ? ?
?  ?     ? 4.5 / 5.0                          ? ?
?  ?     ?????????????? 234 reviews             ? ?
?  ?                                            ? ?
?  ?  ?????  ????????????????? 150         ? ?
?  ?  ????    ????????????????   50         ? ?
?  ?  ???      ????????????????   20         ? ?
?  ?  ??        ????????????????   10         ? ?
?  ?  ?          ????????????????    4         ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Category Ratings ????????????????????????  ?
?  Cleanliness  ?????????? 4.7                    ?
?  Service      ?????????? 4.5                    ?
?  Location     ?????????? 4.8                    ?
?  Value        ?????????? 4.2                    ?
?                                                  ?
????????????????????????????????????????????????????
?  [All] [?5] [?4] [?3] [?2] [?1]              ?
?  Sort: [Most Recent ?]                           ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? ?? John D.        Vietnam        ? Verified? ?
?  ? ?????  Amazing stay!                   ? ?
?  ? Stayed Jan 2024                            ? ?
?  ?                                            ? ?
?  ? The room was spotless and the staff was    ? ?
?  ? incredibly friendly. The location is       ? ?
?  ? perfect, just 5 minutes walk...            ? ?
?  ? [Read More]                                ? ?
?  ?                                            ? ?
?  ? ??? ??? ???                                  ? ?
?  ?                                            ? ?
?  ? ?? 12 helpful                              ? ?
?  ?                                            ? ?
?  ? ??? Hotel Response ?????????????????????   ? ?
?  ? Thank you for your wonderful review!       ? ?
?  ? We're so glad you enjoyed your stay...     ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????
```

### Write Review Screen
```
????????????????????????????????????????????????????
?  ? Cancel        Write Review             Submit ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? ??? ? Marriott Saigon                      ? ?
?  ?    ? Jan 10-12, 2024 • Deluxe King        ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Overall Rating * ?????????????????????????  ?
?           ? ? ? ? ?                        ?
?            Tap to rate                          ?
?                                                  ?
?  ??? Category Ratings ?????????????????????????  ?
?  Cleanliness    ? ? ? ? ?                  ?
?  Service        ? ? ? ? ?                  ?
?  Location       ? ? ? ? ?                  ?
?  Value          ? ? ? ? ?                  ?
?                                                  ?
?  ??? Review Title ?????????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Amazing stay!                              ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Your Review * ????????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Share your experience (min 50 characters)  ? ?
?  ?                                            ? ?
?  ?                                            ? ?
?  ?                                            ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Add Photos ???????????????????????????????  ?
?  ???????? ???????? ????????                    ?
?  ?  +   ? ?      ? ?      ?                    ?
?  ? Add  ? ?      ? ?      ?                    ?
?  ???????? ???????? ????????                    ?
?  Up to 5 photos                                 ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ?            Submit Review                   ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????
```

---

## Review Guidelines (Display to User)

- Minimum 50 characters for comment
- Rating is required (1-5)
- Category ratings are optional
- Maximum 5 images
- Review can be edited within 48 hours
- Must have completed booking to review

---

## TypeScript Types

```typescript
interface ReviewDto {
  id: string;
  rating: number;
  title?: string;
  comment: string;
  cleanlinessRating?: number;
  serviceRating?: number;
  locationRating?: number;
  valueRating?: number;
  stayDate?: string;
  isVerified: boolean;
  helpfulCount: number;
  notHelpfulCount: number;
  guest: ReviewGuestDto;
  managementResponse?: string;
  managementResponseAt?: string;
  images: ReviewImageDto[];
  createdAt: string;
}

interface ReviewGuestDto {
  firstName: string;
  lastName: string;
  avatarUrl?: string;
  nationality?: string;
}

interface ReviewImageDto {
  url: string;
  caption?: string;
}

interface ReviewSummary {
  averageRating: number;
  totalReviews: number;
  ratingBreakdown: Record<string, number>;
  categoryAverages: {
    cleanliness: number;
    service: number;
    location: number;
    value: number;
  };
}

interface CreateReviewRequest {
  bookingId?: string;
  rating: number;
  title?: string;
  comment: string;
  cleanlinessRating?: number;
  serviceRating?: number;
  locationRating?: number;
  valueRating?: number;
  stayDate?: string;
}

enum ReviewStatus {
  Pending = 0,
  Published = 1,
  Rejected = 2,
  Hidden = 3
}
