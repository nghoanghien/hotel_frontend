# Module 15: AI Chatbot

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Chat Widget | Component | Floating chat button |
| Chat Window | Modal/Drawer | Chat interface |
| Conversation History | `/chat/history` | L?ch s? h?i tho?i (logged in users) |

---

## Access Control

| Role | Permissions |
|------|-------------|
| Guest (unauthenticated) | Can chat v?i guest identifier |
| All authenticated users | Full chat v?i conversation history |

---

## Features

- ?? **AI-powered responses** s? d?ng RAG (Retrieval Augmented Generation)
- ?? **Hotel knowledge base** - Hotels, rooms, policies, FAQs
- ?? **Conversation history** - Persistent cho logged-in users
- ?? **Semantic search** - Tìm thông tin liên quan
- ?? **Responsive design** - Ho?t ??ng trên m?i devices

---

## API Endpoints

### 1. Create Conversation
```http
POST /api/bot/conversations
Authorization: Bearer {token} (optional)
```

**Request:**
```json
{
  "title": "H? tr? ??t phòng",
  "guestIdentifier": "session-uuid-for-guest"
}
```

> **Note**: `guestIdentifier` ???c dùng cho user ch?a ??ng nh?p ?? duy trì session

**Response:**
```json
{
  "id": "uuid",
  "ownerId": "uuid-or-null",
  "guestIdentifier": "session-uuid",
  "title": "H? tr? ??t phòng",
  "createdAt": "2024-01-20T10:00:00Z",
  "updatedAt": "2024-01-20T10:00:00Z",
  "messages": []
}
```

---

### 2. Get Conversation
```http
GET /api/bot/conversations/{id}
Authorization: Bearer {token} (optional)
```

**Response:**
```json
{
  "id": "uuid",
  "ownerId": "uuid",
  "guestIdentifier": null,
  "title": "H? tr? ??t phòng",
  "createdAt": "2024-01-20T10:00:00Z",
  "updatedAt": "2024-01-20T10:30:00Z",
  "messages": [
    {
      "id": "uuid",
      "conversationId": "uuid",
      "role": "user",
      "content": "Có khách s?n nào ? Hà N?i không?",
      "tokenCount": null,
      "latencyMs": null,
      "sourceReferences": null,
      "createdAt": "2024-01-20T10:00:00Z"
    },
    {
      "id": "uuid",
      "conversationId": "uuid",
      "role": "assistant",
      "content": "Chúng tôi có nhi?u khách s?n tuy?t v?i ? Hà N?i!\n\n1. **Marriott Hanoi** ?????\n   - V? trí: Trung tâm thành ph?\n   - Giá t? 2,500,000 VND/?êm\n   - Ti?n ích: H? b?i, spa, gym\n\nB?n mu?n bi?t thêm chi ti?t không?",
      "tokenCount": 245,
      "latencyMs": 1250,
      "sourceReferences": "[{\"documentId\":\"uuid\",\"title\":\"Marriott Hotels\",\"similarity\":0.89}]",
      "createdAt": "2024-01-20T10:00:02Z"
    }
  ]
}
```

---

### 3. Get User's Conversations
```http
GET /api/bot/conversations
Authorization: Bearer {token}
```

**Response:**
```json
[
  {
    "id": "uuid",
    "ownerId": "uuid",
    "guestIdentifier": null,
    "title": "H? tr? ??t phòng",
    "createdAt": "2024-01-20T10:00:00Z",
    "updatedAt": "2024-01-20T10:30:00Z",
    "messages": []
  }
]
```

---

### 4. Generate AI Response
```http
POST /api/bot/generate
Authorization: Bearer {token} (optional)
```

**Request:**
```json
{
  "conversationId": "uuid",
  "message": "Có khách s?n nào ? Hà N?i không?",
  "guestIdentifier": "session-uuid-for-guest"
}
```

**Response:**
```json
{
  "id": "uuid",
  "conversationId": "uuid",
  "role": "assistant",
  "content": "Chúng tôi có nhi?u khách s?n tuy?t v?i ? Hà N?i!...",
  "tokenCount": 245,
  "latencyMs": 1250,
  "sourceReferences": "[{\"documentId\":\"uuid\",\"title\":\"Marriott Hotels\",\"similarity\":0.89}]",
  "createdAt": "2024-01-20T10:00:02Z"
}
```

---

### 5. Delete Conversation
```http
DELETE /api/bot/conversations/{id}
Authorization: Bearer {token}
```

---

## Screen Specifications

### Chat Widget (Floating Button)
```
                                    ???????????
                                    ?   ??    ?
                                    ?  Chat   ?
                                    ???????????
                                         ?
                              (Click to open chat)
```

### Chat Window
```
????????????????????????????????????????????????????
?  ?? Hotel Assistant                    [?] [×]   ?
????????????????????????????????????????????????????
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ? ?? Xin chào! Tôi là tr? lý khách s?n.      ? ?
?  ?    Tôi có th? giúp b?n:                    ? ?
?  ?    • Tìm khách s?n và phòng                ? ?
?  ?    • Thông tin ??t phòng                   ? ?
?  ?    • Chính sách và ti?n ích                ? ?
?  ?    • Các câu h?i chung                     ? ?
?  ?                                            ? ?
?  ?    Tôi có th? giúp gì cho b?n?             ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ? Có khách s?n nào ? Hà N?i không?         ??? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ? ?? Chúng tôi có nhi?u khách s?n tuy?t v?i  ? ?
?  ?    ? Hà N?i!                               ? ?
?  ?                                            ? ?
?  ?    1. **Marriott Hanoi**                   ? ?
?  ?       ????? • T? 2,500,000 VND/?êm     ? ?
?  ?       [Xem khách s?n ?]                    ? ?
?  ?                                            ? ?
?  ?    B?n mu?n bi?t thêm chi ti?t không?      ? ?
?  ?                                            ? ?
?  ?    ???????????????????????????????????     ? ?
?  ?    ?? Ngu?n: Marriott Hotels, Hanoi Guide  ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ?????????????????????????????????????????????? ?
?  ? ?? ??? ?ang gõ...                          ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????? [G?i]   ?
?  ? Nh?p tin nh?n...                   ?         ?
?  ??????????????????????????????????????         ?
????????????????????????????????????????????????????
```

### Conversation History (Logged-in Users)
```
????????????????????????????????????????????????????
?  ?? L?ch s? chat                 [+ Chat m?i]    ?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Hôm nay ????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? ?? H? tr? ??t phòng                        ? ?
?  ?    "Có khách s?n nào ? Hà N?i không?"      ? ?
?  ?    10:30 • 5 tin nh?n                      ? ?
?  ?                               [Ti?p t?c ?] ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Hôm qua ???????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? ?? H?i v? ti?n ích phòng                   ? ?
?  ?    "Phòng suite có b?n t?m không?"         ? ?
?  ?    15:20 • 3 tin nh?n                      ? ?
?  ?                               [Ti?p t?c ?] ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
????????????????????????????????????????????????????
```

---

## Quick Reply Suggestions

G?i ý các câu h?i ph? bi?n:
- "Tìm khách s?n ? [thành ph?]"
- "Phòng bao g?m nh?ng gì?"
- "Chính sách h?y phòng"
- "Gi? check-in/check-out"
- "Ph??ng th?c thanh toán"
- "??t phòng ngay"

---

## RAG System Overview

Chatbot s? d?ng **Retrieval Augmented Generation (RAG)**:

```
???????????????????????????????????????????????????????????????????
?                         RAG Pipeline                            ?
???????????????????????????????????????????????????????????????????
?                                                                 ?
?  1. User Query (câu h?i t? user)                               ?
?     ?                                                           ?
?  2. Generate Query Embedding (BGE-M3 via Ollama)               ?
?     ?                                                           ?
?  3. Vector Search trong Knowledge Base (pgvector)              ?
?     ??? Hotels, Rooms, Policies, FAQs                          ?
?     ??? Return top-k similar documents                         ?
?     ?                                                           ?
?  4. Build Context Prompt                                        ?
?     ??? System prompt                                           ?
?     ??? Retrieved documents as context                         ?
?     ??? Conversation history                                   ?
?     ??? User query                                              ?
?     ?                                                           ?
?  5. Generate Response (Gemini LLM)                             ?
?     ?                                                           ?
?  6. Return Response with Source References                     ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
```

---

## Knowledge Base Categories

| Category | Description | Content |
|----------|-------------|---------|
| `hotel` | Thông tin khách s?n | Name, location, amenities, policies |
| `room` | Chi ti?t phòng | Types, pricing, features |
| `policy` | Chính sách | Check-in, h?y phòng, thú c?ng |
| `faq` | Câu h?i th??ng g?p | Common Q&A |
| `promotion` | Khuy?n mãi | Gi?m giá, ?u ?ãi |

---

## TypeScript Types

```typescript
interface BotConversationDto {
  id: string;
  ownerId?: string;
  guestIdentifier?: string;
  title?: string;
  createdAt: string;
  updatedAt: string;
  messages: BotMessageDto[];
}

interface BotMessageDto {
  id: string;
  conversationId: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  tokenCount?: number;
  latencyMs?: number;
  sourceReferences?: string; // JSON string of source info
  createdAt: string;
}

interface CreateConversationRequest {
  title?: string;
  guestIdentifier?: string;
}

interface GenerateBotResponseRequest {
  conversationId: string;
  message: string;
  guestIdentifier?: string;
}
