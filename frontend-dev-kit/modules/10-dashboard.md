# Module 10: Dashboard & Analytics (Partner Portal)

## Authorization & Permissions

> **Hệ thống phân quyền động**: Sử dụng `[Authorize(Policy = "Permission:xxx")]` thay vì role-based cứng

### Permission Policies

| Policy | Mô tả | Cho phép |
|--------|-------|----------|
| `Permission:dashboard.view` | Xem dashboard | HotelManager, Receptionist |
| `Permission:dashboard.viewall` | Xem dashboard toàn hệ thống | SuperAdmin |

### Role-Based Access Matrix

| Action | SuperAdmin | BrandAdmin | HotelManager | Receptionist | Staff |
|--------|------------|------------|--------------|--------------|-------|
| Xem system dashboard | ✅ (viewall) | ❌ | ❌ | ❌ | ❌ |
| Xem brand dashboard | ✅ | ✅ (own) | ❌ | ❌ | ❌ |
| Xem hotel dashboard | ✅ | ❌ | ✅ | ✅ | ✅ |

### Dashboard Scope Logic

Backend sử dụng `PermissionContext` để xác định dashboard scope:
- **SuperAdmin**: Trả về system-wide stats (tất cả brands, hotels)
- **BrandAdmin**: Trả về brand stats (hotels trong brand của mình)
- **HotelManager/Receptionist**: Trả về hotel stats (hotel được assign)

---

## Screens

| Screen | Route | M� t? |
|--------|-------|-------|
| Dashboard | `/manage/dashboard` | T?ng quan c�c metrics |
| Revenue Analytics | `/manage/analytics/revenue` | Ph�n t�ch doanh thu |
| Occupancy Analytics | `/manage/analytics/occupancy` | Ph�n t�ch c�ng su?t |
| Booking Analytics | `/manage/analytics/bookings` | Ph�n t�ch bookings |
| Guest Analytics | `/manage/analytics/guests` | Ph�n t�ch kh�ch h�ng |

---

## API Endpoints

### 1. Get Dashboard Overview
```http
GET /api/dashboard/overview
Authorization: Bearer {token}
```
**Required Policy:** `Permission:dashboard.view` (HotelManager/Receptionist) hoặc `Permission:dashboard.viewall` (SuperAdmin)

**Scope Logic:** Response trả về data dựa trên role của user:
- SuperAdmin: System-wide stats
- BrandAdmin: Brand-level stats
- HotelManager/Receptionist: Hotel-level stats

**Query Parameters:**
| Param | Type | Default | M� t? |
|-------|------|---------|-------|
| `hotelId` | uuid | - | Filter by hotel (optional) |
| `period` | string | today | `today`, `week`, `month`, `year` |

**Response:**
```json
{
  "success": true,
  "data": {
    "todayStats": {
      "checkIns": 15,
      "checkOuts": 12,
      "inHouseGuests": 85,
      "availableRooms": 35,
      "occupancyRate": 70.8,
      "revenue": 31250000
    },
    "periodStats": {
      "totalBookings": 245,
      "bookingsChange": 12.5,
      "totalRevenue": 3125000000,
      "revenueChange": 8.3,
      "averageOccupancy": 75.2,
      "occupancyChange": 5.1,
      "averageDailyRate": 3912500,
      "adrChange": 3.2
    },
    "upcomingArrivals": [
      {
        "id": "uuid",
        "confirmationNumber": "BK-...",
        "guestName": "John Doe",
        "checkInDate": "2024-02-01",
        "roomType": "Deluxe King"
      }
    ],
    "pendingTasks": {
      "pendingBookings": 5,
      "pendingReviews": 12,
      "maintenanceIssues": 3
    },
    "recentActivities": [
      {
        "type": "booking",
        "message": "New booking from John Doe",
        "timestamp": "2024-02-01T10:00:00Z"
      }
    ]
  }
}
```

---

### 2. Get Revenue Analytics
```http
GET /api/dashboard/revenue
Authorization: Bearer {token}
```
**Required Policy:** `Permission:dashboard.view`

**Query Parameters:**
| Param | Type | Default |
|-------|------|---------|
| `hotelId` | uuid | all hotels |
| `startDate` | date | 30 days ago |
| `endDate` | date | today |
| `groupBy` | string | day | `day`, `week`, `month` |

**Response:**
```json
{
  "success": true,
  "data": {
    "totalRevenue": 3125000000,
    "comparisonRevenue": 2875000000,
    "changePercentage": 8.7,
    "chartData": [
      { "date": "2024-01-01", "revenue": 112500000, "bookings": 15 },
      { "date": "2024-01-02", "revenue": 130000000, "bookings": 18 }
    ],
    "byRoomType": [
      { "type": "Deluxe", "revenue": 1375000000, "percentage": 44 },
      { "type": "Suite", "revenue": 875000000, "percentage": 28 },
      { "type": "Standard", "revenue": 875000000, "percentage": 28 }
    ],
    "bySource": [
      { "source": "Website", "revenue": 1875000000, "percentage": 60 },
      { "source": "OTA", "revenue": 937500000, "percentage": 30 },
      { "source": "WalkIn", "revenue": 312500000, "percentage": 10 }
    ]
  }
}
```

---

### 3. Get Occupancy Analytics
```http
GET /api/dashboard/occupancy
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Default |
|-------|------|---------|
| `hotelId` | uuid | all hotels |
| `startDate` | date | 30 days ago |
| `endDate` | date | today |

**Response:**
```json
{
  "success": true,
  "data": {
    "averageOccupancy": 75.2,
    "peakOccupancy": 95.0,
    "lowestOccupancy": 45.0,
    "chartData": [
      { "date": "2024-01-01", "occupancy": 72.5, "availableRooms": 33, "bookedRooms": 87 }
    ],
    "byDayOfWeek": [
      { "day": "Monday", "averageOccupancy": 65.0 },
      { "day": "Friday", "averageOccupancy": 85.0 },
      { "day": "Saturday", "averageOccupancy": 92.0 }
    ],
    "byRoomType": [
      { "type": "Suite", "averageOccupancy": 85.0 },
      { "type": "Deluxe", "averageOccupancy": 75.0 }
    ],
    "forecast": [
      { "date": "2024-02-01", "predictedOccupancy": 80.0 },
      { "date": "2024-02-02", "predictedOccupancy": 85.0 }
    ]
  }
}
```

---

### 4. Get Booking Analytics
```http
GET /api/dashboard/bookings
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "totalBookings": 245,
    "confirmedBookings": 200,
    "cancelledBookings": 30,
    "cancellationRate": 12.2,
    "averageLeadTime": 14.5,
    "averageStayDuration": 2.3,
    "chartData": [
      { "date": "2024-01-01", "bookings": 15, "cancellations": 2 }
    ],
    "bySource": [
      { "source": "Website", "count": 147, "percentage": 60 },
      { "source": "OTA", "count": 73, "percentage": 30 }
    ],
    "topBookingDays": [
      { "day": "Friday", "averageBookings": 12 },
      { "day": "Monday", "averageBookings": 10 }
    ],
    "repeatGuestRate": 25.5
  }
}
```

---

### 5. Get Guest Analytics
```http
GET /api/dashboard/guests
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "totalGuests": 1250,
    "newGuests": 350,
    "returningGuests": 900,
    "returningGuestRate": 72.0,
    "averageGuestRating": 4.5,
    "topNationalities": [
      { "country": "Vietnam", "count": 450, "percentage": 36 },
      { "country": "USA", "count": 200, "percentage": 16 },
      { "country": "Japan", "count": 150, "percentage": 12 }
    ],
    "guestSatisfaction": {
      "overall": 4.5,
      "cleanliness": 4.7,
      "service": 4.5,
      "location": 4.8,
      "value": 4.2
    },
    "reviewStats": {
      "totalReviews": 320,
      "averageRating": 4.5,
      "responseRate": 85.0
    }
  }
}
```

---

### 6. Get Real-time Stats (for live dashboard)
```http
GET /api/dashboard/realtime
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "currentOccupancy": 85,
    "availableRooms": 18,
    "pendingArrivals": 5,
    "pendingDepartures": 3,
    "activeGuests": 102,
    "todayRevenue": 21250000
  }
}
```

---

### 7. Export Report
```http
POST /api/dashboard/export
Authorization: Bearer {token}
```

**Request:**
```json
{
  "reportType": "revenue",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "hotelId": "uuid",
  "format": "xlsx"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "downloadUrl": "https://...",
    "expiresAt": "2024-02-01T12:00:00Z"
  }
}
```

---

## Screen Specifications

### Dashboard Overview Screen
```
????????????????????????????????????????????????????????????????????????
?  ?? Dashboard              Sunset Beach Resort ?       Period: Week ??
????????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ??? Today's Snapshot ????????????????????????????????????????????? ?
?  ?????????????? ?????????????? ?????????????? ??????????????       ?
?  ?    15      ? ?    12      ? ?    85      ? ?   70.8%    ?       ?
?  ? Check-ins  ? ? Check-outs ? ? In-House   ? ? Occupancy  ?       ?
?  ? ?? +3      ? ? ?? +2      ? ?            ? ? ?? +5%     ?       ?
?  ?????????????? ?????????????? ?????????????? ??????????????       ?
?                                                                      ?
?  ??? This Week's Performance ?????????????????????????????????????? ?
?  ??????????????????????????????? ???????????????????????????????   ?
?  ? Revenue      3.125.000.000  ? ? Bookings               245  ?   ?
?  ? (VND)                       ? ?                             ?   ?
?  ? ?? +8.3% vs last week       ? ? ?? +12.5% vs last week      ?   ?
?  ?                             ? ?                             ?   ?
?  ? [Revenue Chart ~~~~~~~~~~~~]? ? [Bookings Chart ~~~~~~~~~~] ?   ?
?  ?                             ? ?                             ?   ?
?  ??????????????????????????????? ???????????????????????????????   ?
?                                                                      ?
?  ??? Upcoming Arrivals ??????????????????????????????? [View All] ? ?
?  ? John Doe      ? Feb 1, 14:00 ? Deluxe King #301 ? ? Confirmed ? ?
?  ? Jane Smith    ? Feb 1, 15:00 ? Suite #501       ? ? Confirmed ? ?
?  ? Bob Wilson    ? Feb 1, 16:00 ? Standard #102    ? ? Pending   ? ?
?                                                                      ?
?  ??? Pending Tasks ???????????????????????????????????????????????? ?
?  ?????????????????????? ?????????????????????? ??????????????????  ?
?  ? ? 5 Pending       ? ? ? 12 Pending      ? ? ?? 3 Issues    ?  ?
?  ?    Bookings        ? ?    Reviews         ? ?    Maintenance ?  ?
?  ?????????????????????? ?????????????????????? ??????????????????  ?
?                                                                      ?
?  ??? Recent Activity ?????????????????????????????????????????????? ?
?  ? ?? 10:30 ? New booking from John Doe - BK-20240201-ABC123      ? ?
?  ? ?? 10:25 ? Payment received 6.850.000 VND - BK-20240201-XYZ789 ? ?
?  ? ? 10:15 ? New 5-star review from Jane Smith                   ? ?
?  ? ?? 10:00 ? Guest checked in - Room 301                         ? ?
?                                                                      ?
????????????????????????????????????????????????????????????????????????

### Revenue Analytics Screen
```
????????????????????????????????????????????????????????????????????????
?  ?? Revenue Analytics                            [?? Export Report] ?
????????????????????????????????????????????????????????????????????????
?  Date Range: [Jan 1, 2024] to [Jan 31, 2024]     Hotel: [All ?]     ?
????????????????????????????????????????????????????????????????????????
?                                                                      ?
?  ?????????????? ?????????????? ?????????????? ??????????????       ?
?  ?3.125.000.000? ? 3.912.500  ? ?104.167.000 ? ?   +8.7%    ?       ?
?  ?Total Rev VND? ?  ADR VND   ? ?  Avg/Day   ? ? vs Last Mo ?       ?
?  ?????????????? ?????????????? ?????????????? ??????????????       ?
?                                                                      ?
?  ??? Revenue Trend ???????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????????????????????????? ?
?  ? $6K ?                    ???                                   ? ?
?  ?     ?              ???  ?   ?   ???                            ? ?
?  ? $4K ?   ???  ???  ?   ??     ? ?   ?                           ? ?
?  ?     ?  ?   ??   ??            ?     ?                          ? ?
?  ? $2K ? ?                                                        ? ?
?  ?     ???????????????????????????????????????????????????????????? ?
?  ?       1    5    10   15   20   25   30                         ? ?
?  ?????????????????????????????????????????????????????????????????? ?
?                                                                      ?
?  ??? By Room Type ???????????????? ??? By Booking Source ?????????? ?
?  ??????????????????????????????   ??????????????????????????????   ?
?  ? [PIE CHART]                ?   ? [PIE CHART]                ?   ?
?  ?                            ?   ?                            ?   ?
?  ? ? Deluxe   44% 1.375.000k ?   ? ? Website  60% 1.875.000k ?   ?
?  ? ? Suite    28%   875.000k ?   ? ? OTA      30%   937.500k ?   ?
?  ? ? Standard 28%   875.000k ?   ? ? WalkIn   10%   312.500k ?   ?
?  ??????????????????????????????   ??????????????????????????????   ?
?                                                                      ?
????????????????????????????????????????????????????????????????????????

---

## TypeScript Types

```typescript
interface DashboardOverview {
  todayStats: TodayStats;
  periodStats: PeriodStats;
  upcomingArrivals: UpcomingArrival[];
  pendingTasks: PendingTasks;
  recentActivities: ActivityItem[];
}

interface TodayStats {
  checkIns: number;
  checkOuts: number;
  inHouseGuests: number;
  availableRooms: number;
  occupancyRate: number;
  revenue: number;
}

interface PeriodStats {
  totalBookings: number;
  bookingsChange: number;
  totalRevenue: number;
  revenueChange: number;
  averageOccupancy: number;
  occupancyChange: number;
  averageDailyRate: number;
  adrChange: number;
}

interface RevenueAnalytics {
  totalRevenue: number;
  comparisonRevenue: number;
  changePercentage: number;
  chartData: RevenueChartPoint[];
  byRoomType: RevenueByCategory[];
  bySource: RevenueByCategory[];
}

interface RevenueChartPoint {
  date: string;
  revenue: number;
  bookings: number;
}

interface RevenueByCategory {
  type: string;
  revenue: number;
  percentage: number;
}

interface OccupancyAnalytics {
  averageOccupancy: number;
  peakOccupancy: number;
  lowestOccupancy: number;
  chartData: OccupancyChartPoint[];
  byDayOfWeek: DayOccupancy[];
  byRoomType: RoomTypeOccupancy[];
  forecast: OccupancyForecast[];
}

interface OccupancyChartPoint {
  date: string;
  occupancy: number;
  availableRooms: number;
  bookedRooms: number;
}

// ============ PERMISSION TYPES ============

interface UserPermissions {
  permissions: string[];
  scope: 'system' | 'brand' | 'hotel';
  brandId?: string;
  hotelId?: string;
}

interface DashboardScope {
  scope: 'system' | 'brand' | 'hotel';
  entityId?: string;
}

const PERMISSION_POLICIES = {
  DASHBOARD_VIEW: 'Permission:dashboard.view',
  DASHBOARD_VIEW_ALL: 'Permission:dashboard.viewall',
} as const;
