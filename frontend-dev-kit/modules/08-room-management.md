# Module 08: Room Management (Partner Portal)

## Authorization & Permissions

> **Hệ thống phân quyền động**: Sử dụng `[Authorize(Policy = "Permission:xxx")]` thay vì role-based cứng

### Permission Policies

| Policy | Mô tả | Cho phép |
|--------|-------|----------|
| `Permission:rooms.read` | Xem rooms | Tất cả staff của hotel |
| `Permission:rooms.create` | Tạo room mới | HotelManager |
| `Permission:rooms.update` | Cập nhật room | HotelManager |
| `Permission:rooms.delete` | Xóa room | HotelManager |

### Role-Based Access Matrix

| Action | SuperAdmin | BrandAdmin | HotelManager | Receptionist | Staff |
|--------|------------|------------|--------------|--------------|-------|
| Xem rooms | ❌ | ❌ | ✅ (own) | ✅ (own) | ✅ (own) |
| Tạo room | ❌ | ❌ | ✅ | ❌ | ❌ |
| Sửa room | ❌ | ❌ | ✅ | ❌ | ❌ |
| Xóa room | ❌ | ❌ | ✅ | ❌ | ❌ |

---

## Screens

| Screen | Route | M� t? |
|--------|-------|-------|
| Rooms List | `/manage/hotels/[id]/rooms` | Danh s�ch ph�ng |
| Room Detail | `/manage/hotels/[id]/rooms/[roomId]` | Chi ti?t & ch?nh s?a |
| Add Room | `/manage/hotels/[id]/rooms/new` | Th�m ph�ng m?i |
| Bulk Add | `/manage/hotels/[id]/rooms/bulk-add` | Th�m nhi?u ph�ng |
| Pricing | `/manage/hotels/[id]/rooms/[roomId]/pricing` | Qu?n l� gi� |
| Availability | `/manage/hotels/[id]/rooms/availability` | Calendar availability |

---

## API Endpoints

### 1. Get Rooms by Hotel
```http
GET /api/hotels/{hotelId}/rooms
Authorization: Bearer {token}
```
**Required Policy:** `Permission:rooms.read`

**Query Parameters:**
| Param | Type | Default | M� t? |
|-------|------|---------|-------|
| `type` | string | - | Filter by room type |
| `status` | string | - | `Available`, `Occupied`, `Maintenance` |
| `floor` | int | - | Filter by floor |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "roomNumber": "301",
      "type": "Deluxe",
      "bedType": "King",
      "numberOfBeds": 1,
      "maxOccupancy": 2,
      "sizeInSquareMeters": 35,
      "floor": 3,
      "basePrice": 2500000,
      "currentPrice": 2500000,
      "currency": "VND",
      "status": "Available",
      "isActive": true,
      "todayStatus": "Available",
      "mainImageUrl": "https://..."
    }
  ]
}
```

---

### 2. Get Room Detail
```http
GET /api/rooms/{id}
Authorization: Bearer {token}
```
**Required Policy:** `Permission:rooms.read`

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "hotelId": "uuid",
    "roomNumber": "301",
    "type": "Deluxe",
    "bedType": "King",
    "numberOfBeds": 1,
    "maxOccupancy": 2,
    "maxAdults": 2,
    "maxChildren": 1,
    "sizeInSquareMeters": 35,
    "floor": 3,
    "description": "Spacious room with stunning city view",
    "basePrice": 2500000,
    "weekendPrice": 3000000,
    "extraAdultPrice": 500000,
    "extraChildPrice": 250000,
    "currency": "VND",
    "hasView": true,
    "viewDescription": "City view",
    "isPetFriendly": false,
    "isAccessible": true,
    "isSmokingAllowed": false,
    "status": "Available",
    "isActive": true,
    "images": [
      { "id": "uuid", "url": "https://...", "isPrimary": true }
    ],
    "amenities": [
      { "id": "uuid", "name": "Air Conditioning", "icon": "snowflake" }
    ]
  }
}
```

---

### 3. Create Room
```http
POST /api/hotels/{hotelId}/rooms
Authorization: Bearer {token}
```

**Request:**
```json
{
  "roomNumber": "301",
  "type": "Deluxe",
  "bedType": "King",
  "numberOfBeds": 1,
  "maxOccupancy": 2,
  "maxAdults": 2,
  "maxChildren": 1,
  "sizeInSquareMeters": 35,
  "floor": 3,
  "description": "Spacious room with stunning city view",
  "basePrice": 2500000,
  "weekendPrice": 3000000,
  "extraAdultPrice": 500000,
  "extraChildPrice": 250000,
  "currency": "VND",
  "hasView": true,
  "viewDescription": "City view",
  "isPetFriendly": false,
  "isAccessible": true,
  "isSmokingAllowed": false
}
```

---

### 4. Bulk Create Rooms
```http
POST /api/hotels/{hotelId}/rooms/bulk
Authorization: Bearer {token}
```

**Request:**
```json
{
  "type": "Deluxe",
  "bedType": "King",
  "numberOfBeds": 1,
  "maxOccupancy": 2,
  "basePrice": 2500000,
  "weekendPrice": 3000000,
  "floor": 3,
  "roomNumbers": ["301", "302", "303", "304", "305"],
  "copyAmenitiesFromRoomId": "uuid"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "createdCount": 5,
    "rooms": [...]
  }
}
```

---

### 5. Update Room
```http
PUT /api/rooms/{id}
Authorization: Bearer {token}
```

---

### 6. Delete Room
```http
DELETE /api/rooms/{id}
Authorization: Bearer {token}
```

---

### 7. Upload Room Image
```http
POST /api/rooms/{id}/images
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [image file]
isPrimary: false
```

---

### 8. Update Room Pricing (Special Dates)
```http
PUT /api/rooms/{id}/pricing
Authorization: Bearer {token}
```

**Request:**
```json
{
  "pricingRules": [
    {
      "startDate": "2024-02-14",
      "endDate": "2024-02-16",
      "price": 3800000,
      "reason": "Valentine's Day"
    },
    {
      "startDate": "2024-04-28",
      "endDate": "2024-05-01",
      "price": 3500000,
      "reason": "Holiday"
    }
  ]
}
```

---

### 9. Get Room Availability Calendar
```http
GET /api/rooms/{id}/availability
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | M� t? |
|-------|------|-------|
| `startDate` | date | Start of range |
| `endDate` | date | End of range |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-02-01",
      "status": "Available",
      "price": 2500000,
      "bookingId": null
    },
    {
      "date": "2024-02-02",
      "status": "Booked",
      "price": 2500000,
      "bookingId": "uuid",
      "guestName": "John Doe"
    }
  ]
}
```

---

### 10. Block Room Dates
```http
POST /api/rooms/{id}/block
Authorization: Bearer {token}
```

**Request:**
```json
{
  "startDate": "2024-02-15",
  "endDate": "2024-02-20",
  "reason": "Maintenance"
}
```

---

### 11. Unblock Room Dates
```http
POST /api/rooms/{id}/unblock
Authorization: Bearer {token}
```

**Request:**
```json
{
  "startDate": "2024-02-15",
  "endDate": "2024-02-20"
}
```

---

### 12. Update Room Amenities
```http
PUT /api/rooms/{id}/amenities
Authorization: Bearer {token}
```

**Request:**
```json
{
  "amenityIds": ["uuid1", "uuid2", "uuid3"]
}
```

---

### 13. Update Room Status
```http
PUT /api/rooms/{id}/status
Authorization: Bearer {token}
```

**Request:**
```json
{
  "status": "Maintenance",
  "notes": "AC repair until Feb 20"
}
```

---

## Room Status Management API

### 14. Get Rooms by Status
```http
GET /api/hotels/{hotelId}/rooms/status/{status}
Authorization: Bearer {token}
```
**Status values:** `Available`, `Occupied`, `Maintenance`, `Cleaning`, `OutOfOrder`, `Reserved`

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "roomNumber": "301",
      "type": "Deluxe",
      "status": "Maintenance",
      "floor": 3
    }
  ]
}
```

### 15. Get Maintenance Rooms
```http
GET /api/hotels/{hotelId}/rooms/maintenance
Authorization: Bearer {token}
```
Lấy tất cả rooms cần bảo trì (Maintenance, Cleaning, OutOfOrder)

**Response:**
```json
{
  "success": true,
  "data": {
    "maintenance": [
      { "id": "uuid", "roomNumber": "301", "status": "Maintenance", "issue": "AC repair" }
    ],
    "cleaning": [
      { "id": "uuid", "roomNumber": "302", "status": "Cleaning" }
    ],
    "outOfOrder": [
      { "id": "uuid", "roomNumber": "303", "status": "OutOfOrder", "reason": "Renovations" }
    ]
  }
}
```

### 16. Report Room Maintenance
```http
POST /api/hotels/{hotelId}/rooms/{id}/maintenance
Authorization: Bearer {token}
```
Báo cáo room cần bảo trì/dọn dẹp

**Request:**
```json
{
  "issue": "Plumbing",  // Plumbing, Electrical, Cleaning, Damages, Other
  "description": "Bathroom pipe leak",
  "priority": "High",   // Low, Medium, High, Urgent
  "reportedBy": "Front Desk"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Maintenance reported successfully",
  "data": {
    "roomId": "uuid",
    "newStatus": "Maintenance",
    "ticketId": "TKT-001"
  }
}
```

### 17. Mark Room Available (Ready after cleaning)
```http
PATCH /api/hotels/{hotelId}/rooms/{id}/available
Authorization: Bearer {token}
```
Đánh dấu room sẵn sàng sau khi dọn dẹp/bảo trì

**Response:**
```json
{
  "success": true,
  "message": "Room marked as available",
  "data": {
    "id": "uuid",
    "roomNumber": "301",
    "status": "Available"
  }
}
```

### 18. Get Room Status Summary
```http
GET /api/hotels/{hotelId}/rooms/status-summary
Authorization: Bearer {token}
```
Lấy tổng quan trạng thái tất cả rooms

**Response:**
```json
{
  "success": true,
  "data": {
    "totalRooms": 120,
    "available": 85,
    "occupied": 25,
    "maintenance": 3,
    "cleaning": 5,
    "outOfOrder": 2
  }
}
```

---

## Screen Specifications

### Rooms List Screen
```
????????????????????????????????????????????????????
?  ? Back      Rooms (120)            [+ Add Room] ?
????????????????????????????????????????????????????
?  [All] [Available] [Occupied] [Maintenance]      ?
?  Floor: [All ?]  Type: [All ?]                   ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? #301 ? Deluxe King          ? Available   ? ?
?  ?      ? ?? 2 max � ??? King � 35m�          ? ?
?  ?      ? 2,500,000 VND / ?�m                ? ?
?  ?      ?                      [Edit] [���]  ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? #302 ? Deluxe King          ? Occupied    ? ?
?  ?      ? ?? 2 max � ??? King � 35m�          ? ?
?  ?      ? Guest: John Doe (Feb 1-3)          ? ?
?  ?      ?                      [View] [���]  ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? #303 ? Deluxe King          ? Maintenance ? ?
?  ?      ? ?? 2 max � ??? King � 35m�          ? ?
?  ?      ? AC repair until Feb 20             ? ?
?  ?      ?                      [Edit] [���]  ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Floor 4 ??????????????????????????????????  ?
?  [More rooms...]                                ?
????????????????????????????????????????????????????
```

### Room Edit Screen
```
????????????????????????????????????????????????????
?  ? Back           Room #301              Save    ?
????????????????????????????????????????????????????
?  [Details] [Pricing] [Availability] [Images]     ?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Basic Information ????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Room Number *    ? ? Floor                ?  ?
?  ? 301              ? ? 3                    ?  ?
?  ???????????????????? ????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Room Type *      ? ? Bed Type *           ?  ?
?  ? Deluxe        ?  ? ? King             ?   ?  ?
?  ???????????????????? ????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Number of Beds   ? ? Size (m�)            ?  ?
?  ? 1                ? ? 35                   ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? Capacity ?????????????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Max Adults *     ? ? Max Children         ?  ?
?  ? 2                ? ? 1                    ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? Features ?????????????????????????????????  ?
?  ? Has View: City view                          ?
?  ? Pet Friendly                                 ?
?  ? Accessible                                   ?
?  ? Smoking Allowed                              ?
?                                                  ?
?  ??? Amenities ????????????????????????????????  ?
?  ? Air Conditioning  ? TV  ? Mini Bar           ?
?  ? Safe  ? Hair Dryer  ? Bathtub                ?
?                                                  ?
????????????????????????????????????????????????????
```

### Room Pricing Tab
```
????????????????????????????????????????????????????
?  [Details] [Pricing] [Availability] [Images]     ?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Base Pricing ?????????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Weekday Price *  ? ? Weekend Price        ?  ?
?  ? 2,500,000 VND    ? ? 3,000,000 VND        ?  ?
?  ???????????????????? ????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Extra Adult      ? ? Extra Child          ?  ?
?  ? 500,000 VND      ? ? 250,000 VND          ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? Special Date Pricing ????????? [+ Add]????  ?
?  ?????????????????????????????????????????????? ?
?  ? Feb 14-16, 2024      3,800,000 VND        ? ?
?  ? Valentine's Day                   [???]    ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Apr 28 - May 1, 2024   3,500,000 VND      ? ?
?  ? Holiday                           [???]    ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
????????????????????????????????????????????????????
```

### Availability Calendar
```
????????????????????????????????????????????????????
?  [Details] [Pricing] [Availability] [Images]     ?
????????????????????????????????????????????????????
?      ? February 2024 ?                          ?
?  ?????????????????????????????                 ?
?  ?Mon?Tue?Wed?Thu?Fri?Sat?Sun?                 ?
?  ?????????????????????????????                 ?
?  ?   ?   ?   ? 1 ? 2 ? 3 ? 4 ?                 ?
?  ?   ?   ?   ??? ??? ??? ??? ?                 ?
?  ?   ?   ?   ?2.5M?2.5M?2.5M?2.5M?                 ?
?  ?????????????????????????????                 ?
?  ? 5 ? 6 ? 7 ? 8 ? 9 ?10 ?11 ?                 ?
?  ??? ??? ??? ??? ??? ??? ??? ?                 ?
?  ?2.5M?2.5M?2.5M?2.5M?2.5M?3M ?3M ?                 ?
?  ?????????????????????????????                 ?
?  ?12 ?13 ?14 ?15 ?16 ?17 ?18 ?                 ?
?  ??? ??? ??? ??? ??? ??? ??? ?                 ?
?  ?2.5M?2.5M?3.8M?   ?   ?   ?   ?                 ?
?  ?????????????????????????????                 ?
?                                                  ?
?  Legend: ?? Available ?? Booked ?? Blocked ? N/A?
?                                                  ?
?  [Block Dates]  [Unblock Dates]                  ?
????????????????????????????????????????????????????
```

---

## TypeScript Types

```typescript
interface RoomDto {
  id: string;
  hotelId: string;
  roomNumber: string;
  type: RoomType;
  bedType: BedType;
  numberOfBeds: number;
  maxOccupancy: number;
  maxAdults?: number;
  maxChildren?: number;
  sizeInSquareMeters: number;
  floor?: number;
  description?: string;
  basePrice: number;
  weekendPrice?: number;
  extraAdultPrice?: number;
  extraChildPrice?: number;
  currency: string;
  hasView: boolean;
  viewDescription?: string;
  isPetFriendly: boolean;
  isAccessible: boolean;
  isSmokingAllowed: boolean;
  status: RoomStatus;
  isActive: boolean;
  images: RoomImageDto[];
  amenities: AmenityDto[];
}

enum RoomType {
  Standard = 0,
  Deluxe = 1,
  Suite = 2,
  Family = 3,
  Presidential = 4,
  Dormitory = 5,
  Studio = 6,
  Penthouse = 7
}

enum BedType {
  Single = 0,
  Double = 1,
  Queen = 2,
  King = 3,
  Twin = 4,
  Bunk = 5,
  SofaBed = 6
}

enum RoomStatus {
  Available = 0,
  Occupied = 1,
  Maintenance = 2,
  Cleaning = 3,
  OutOfOrder = 4,
  Reserved = 5
}

interface CreateRoomRequest {
  roomNumber: string;
  type: RoomType;
  bedType: BedType;
  numberOfBeds: number;
  maxOccupancy: number;
  maxAdults?: number;
  maxChildren?: number;
  sizeInSquareMeters: number;
  floor?: number;
  description?: string;
  basePrice: number;
  weekendPrice?: number;
  extraAdultPrice?: number;
  extraChildPrice?: number;
  hasView?: boolean;
  viewDescription?: string;
  isPetFriendly?: boolean;
  isAccessible?: boolean;
  isSmokingAllowed?: boolean;
}

interface RoomPricingRule {
  startDate: string;
  endDate: string;
  price: number;
  reason?: string;
}

interface RoomAvailability {
  date: string;
  status: 0 | 1 | 2; // 0: Available, 1: Booked, 2: Blocked
  price: number;
  bookingId?: string;
  guestName?: string;
}
