# Module 11: Promotions & Coupons

## Screens

| Screen | Route | Mô t? |
|--------|-------|-------|
| Promotions List | `/manage/promotions` | Danh sách promotions |
| Create Promotion | `/manage/promotions/new` | T?o m?i |
| Promotion Detail | `/manage/promotions/[id]` | Chi ti?t & ch?nh s?a |
| Coupon Analytics | `/manage/promotions/[id]/analytics` | Phân tích hi?u qu? |

---

## API Endpoints

### 1. Get Promotions
```http
GET /api/promotions
Authorization: Bearer {token}
```

**Query Parameters:**
| Param | Type | Default | Mô t? |
|-------|------|---------|-------|
| `hotelId` | uuid | - | L?c theo khách s?n |
| `status` | string | - | `Active`, `Scheduled`, `Expired` |
| `type` | string | - | `Percentage`, `FixedAmount`, `FreeNight` |
| `page` | int | 1 | |
| `pageSize` | int | 10 | |

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "code": "SUMMER20",
        "name": "Khuy?n mãi Hè 2024",
        "description": "Gi?m 20% cho t?t c? ??t phòng",
        "type": "Percentage",
        "discountValue": 20.00,
        "minBookingAmount": 2000000,
        "maxDiscountAmount": 5000000,
        "startDate": "2024-06-01T00:00:00Z",
        "endDate": "2024-08-31T23:59:59Z",
        "maxUsageCount": 1000,
        "currentUsageCount": 234,
        "maxUsagePerUser": 1,
        "status": "Active",
        "isPublic": true,
        "hotelId": "uuid",
        "createdAt": "2024-05-15T10:00:00Z"
      }
    ],
    "totalCount": 15
  }
}
```

---

### 2. Get Promotion Detail
```http
GET /api/promotions/{id}
Authorization: Bearer {token}
```

---

### 3. Create Promotion
```http
POST /api/promotions
Authorization: Bearer {token}
```

**Request:**
```json
{
  "code": "SUMMER20",
  "name": "Khuy?n mãi Hè 2024",
  "description": "Gi?m 20% cho t?t c? ??t phòng mùa hè",
  "type": "Percentage",
  "discountValue": 20.00,
  "minBookingAmount": 2000000,
  "maxDiscountAmount": 5000000,
  "startDate": "2024-06-01T00:00:00Z",
  "endDate": "2024-08-31T23:59:59Z",
  "maxUsageCount": 1000,
  "maxUsagePerUser": 1,
  "minNights": 2,
  "isPublic": true,
  "hotelId": "uuid"
}
```

---

### 4. Update Promotion
```http
PUT /api/promotions/{id}
Authorization: Bearer {token}
```

---

### 5. Toggle Promotion Status
```http
POST /api/promotions/{id}/toggle
Authorization: Bearer {token}
```

---

### 6. Delete Promotion
```http
DELETE /api/promotions/{id}
Authorization: Bearer {token}
```

---

### 7. Validate Promotion Code (for guests)
```http
POST /api/promotions/validate
Authorization: Bearer {token}
```

**Request:**
```json
{
  "code": "SUMMER20",
  "hotelId": "uuid",
  "bookingAmount": 5000000,
  "checkInDate": "2024-06-15",
  "checkOutDate": "2024-06-17"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "isValid": true,
    "code": "SUMMER20",
    "promotionName": "Khuy?n mãi Hè 2024",
    "discountType": "Percentage",
    "discountValue": 20.00,
    "calculatedDiscount": 1000000,
    "message": "Gi?m 20% ?ã ???c áp d?ng!"
  }
}
```

**Invalid Response:**
```json
{
  "success": true,
  "data": {
    "isValid": false,
    "code": "SUMMER20",
    "message": "C?n t?i thi?u 2 ?êm ?? s? d?ng mã này"
  }
}
```

---

### 8. Get Promotion Usage Statistics
```http
GET /api/promotions/{id}/usage
Authorization: Bearer {token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "totalUsage": 234,
    "remainingUsage": 766,
    "totalDiscountGiven": 234000000,
    "averageDiscount": 1000000,
    "usageByDate": [
      { "date": "2024-06-01", "count": 12, "discount": 12000000 },
      { "date": "2024-06-02", "count": 18, "discount": 18000000 }
    ]
  }
}
```

---

## Screen Specifications

### Promotions List Screen
```
????????????????????????????????????????????????????
?  ?? Khuy?n mãi                   [+ T?o m?i]     ?
????????????????????????????????????????????????????
?  [T?t c?] [?ang ho?t ??ng 8] [?ã lên l?ch 3] [H?t h?n]?
?  Khách s?n: [T?t c? ?]  Lo?i: [T?t c? ?]         ?
????????????????????????????????????????????????????
?  ?????????????????????????????????????????????? ?
?  ? SUMMER20                     ? Ho?t ??ng   ? ?
?  ? Khuy?n mãi Hè 2024                         ? ?
?  ? Gi?m 20% • T?i thi?u 2tr • T?i ?a 5tr     ? ?
?  ? ?????????????????????????????????????      ? ?
?  ? ?? 01/06 - 31/08/2024                      ? ?
?  ? ?? 234/1000 ?ã dùng (23.4%)                ? ?
?  ?                          [S?a] [T?t]       ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? VIPGUEST                    ? ?ã lên l?ch  ? ?
?  ? Gi?m giá VIP                               ? ?
?  ? Gi?m 500,000 VND • T?i thi?u 2 ?êm        ? ?
?  ? ?????????????????????????????????????      ? ?
?  ? ?? 01/03 - 31/03/2024                      ? ?
?  ? ?? 0/500 ?ã dùng                           ? ?
?  ?                          [S?a] [Xóa]       ? ?
?  ?????????????????????????????????????????????? ?
????????????????????????????????????????????????????
```

### Create Promotion Screen
```
????????????????????????????????????????????????????
?  ? Quay l?i     T?o khuy?n mãi           L?u    ?
????????????????????????????????????????????????????
?                                                  ?
?  ??? Thông tin c? b?n ?????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? Mã khuy?n mãi *                            ? ?
?  ? SUMMER20                    [?? T?o t? ??ng]? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Tên khuy?n mãi *                           ? ?
?  ? Khuy?n mãi Hè 2024                         ? ?
?  ?????????????????????????????????????????????? ?
?  ?????????????????????????????????????????????? ?
?  ? Mô t?                                      ? ?
?  ? Gi?m 20% cho t?t c? ??t phòng mùa hè       ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Cài ??t gi?m giá ?????????????????????????  ?
?  Lo?i gi?m: [? Ph?n tr?m  ? S? ti?n  ? ?êm mi?n phí]?
?  ???????????????????? ????????????????????????  ?
?  ? Giá tr? gi?m *   ? ? Gi?m t?i ?a          ?  ?
?  ? 20 %             ? ? 5,000,000 VND        ?  ?
?  ???????????????????? ????????????????????????  ?
?  ?????????????????????????????????????????????? ?
?  ? ??n hàng t?i thi?u                         ? ?
?  ? 2,000,000 VND                              ? ?
?  ?????????????????????????????????????????????? ?
?                                                  ?
?  ??? Th?i gian hi?u l?c ???????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? Ngày b?t ??u *   ? ? Ngày k?t thúc *      ?  ?
?  ? 01/06/2024       ? ? 31/08/2024           ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? Gi?i h?n s? d?ng ?????????????????????????  ?
?  ???????????????????? ????????????????????????  ?
?  ? T?ng s? l??t     ? ? M?i ng??i dùng       ?  ?
?  ? 1000             ? ? 1                    ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ??? ?i?u ki?n (Tùy ch?n) ?????????????????????  ?
?  Áp d?ng cho khách s?n: [T?t c? ?]              ?
?  ???????????????????? ????????????????????????  ?
?  ? T?i thi?u ?êm    ? ? T?i ?a ?êm           ?  ?
?  ? 2                ? ? -                    ?  ?
?  ???????????????????? ????????????????????????  ?
?                                                  ?
?  ? Công khai (Hi?n th? cho t?t c? khách)        ?
?                                                  ?
????????????????????????????????????????????????????
```

---

## Promotion Types

| Type | Enum | Mô t? |
|------|------|-------|
| Ph?n tr?m | `Percentage` | Gi?m X% trên t?ng ??n |
| S? ti?n c? ??nh | `FixedAmount` | Gi?m X VND |
| ?êm mi?n phí | `FreeNight` | ? N ?êm t?ng 1 ?êm |
| Nâng c?p phòng | `Upgrade` | Mi?n phí upgrade |

---

## Error Handling

| Error | Message |
|-------|---------|
| 400 | Mã khuy?n mãi ?ã t?n t?i |
| 400 | Ngày k?t thúc ph?i sau ngày b?t ??u |
| 404 | Không tìm th?y khuy?n mãi |
| 403 | Không có quy?n qu?n lý khuy?n mãi này |

---

## TypeScript Types

```typescript
interface PromotionDto {
  id: string;
  code: string;
  name: string;
  description?: string;
  type: PromotionType;
  discountValue: number;
  minBookingAmount?: number;
  maxDiscountAmount?: number;
  startDate: string;
  endDate: string;
  maxUsageCount?: number;
  currentUsageCount: number;
  maxUsagePerUser: number;
  status: PromotionStatus;
  isPublic: boolean;
  hotelId?: string;
  createdAt: string;
}

enum PromotionType {
  Percentage = 0,
  FixedAmount = 1,
  FreeNight = 2,
  Upgrade = 3
}

enum PromotionStatus {
  Draft = 0,
  Active = 1,
  Paused = 2,
  Expired = 3,
  Cancelled = 4
}

interface ValidatePromotionRequest {
  code: string;
  hotelId?: string;
  bookingAmount: number;
  checkInDate: string;
  checkOutDate: string;
}

interface ValidatePromotionResult {
  isValid: boolean;
  code: string;
  promotionName?: string;
  discountType?: PromotionType;
  discountValue?: number;
  calculatedDiscount?: number;
  message: string;
}

interface PromotionUsageStatsDto {
  totalUsage: number;
  remainingUsage?: number;
  totalDiscountGiven: number;
  averageDiscount: number;
  usageByDate: UsagePointDto[];
}

interface UsagePointDto {
  date: string;
  count: number;
  discount: number;
}
